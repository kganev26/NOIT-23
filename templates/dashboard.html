<!DOCTYPE html>
<html lang="bg">

<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

  <div class="container">

    <div class="sidebar">
      <div class="logo">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo">
      </div>

      <button class="tab-button active" onclick="openTab(event, 'dashboardTab')">
        Dashboard
      </button>

      <button class="tab-button" onclick="openTab(event, 'otherTab')">
        Други
      </button>
    </div>

    <div class="content-area">

      <div id="dashboardTab" class="tab-content" style="display:block;">
        <div class="cards">

          <div class="card stats">
            <h3>XP</h3>
            <p class="xp">{{ user.xp }}</p>
            <p class="level">Ниво {{ user.level }}</p>
          </div>

          <div class="card missions">
            <h3>Мисии</h3>

            {% if not missions %}
            <button onclick="generateMissions()">Генерирай мисии</button>
            {% endif %}

            {% if missions %}
            <ul>
              {% for mission in missions %}
              <li>
                <span>{{ mission.title }}</span>

                <div class="timer-controls">
                  <span id="timer-{{ mission.id }}">
                    {{ mission.duration }}:00
                  </span>

                  <button id="start-{{ mission.id }}" onclick="startTimer({{ mission.id }}, {{ mission.duration }})">
                    Започни
                  </button>

                  <button id="complete-{{ mission.id }}" disabled onclick="completeMission({{ mission.id }})">
                    Завърши
                  </button>
                </div>
              </li>
              {% endfor %}
            </ul>
            {% endif %}
          </div>

        </div>
      </div>

      <div id="otherTab" class="tab-content" style="display:none;">
        <div class="card">
          <p>Тук ще са другите табове.</p>
        </div>
      </div>

    </div>
  </div>

  <script>
    function openTab(event, tabId) {
      document.querySelectorAll('.tab-content')
        .forEach(t => t.style.display = 'none');
      document.querySelectorAll('.tab-button')
        .forEach(b => b.classList.remove('active'));

      document.getElementById(tabId).style.display = 'block';
      event.currentTarget.classList.add('active');
    }

    function generateMissions() {
      fetch('/generate-missions')
        .then(() => location.reload());
    }

    function completeMission(id) {
      fetch(`/complete-mission/${id}`, { method: 'POST' })
        .then(res => {
          if (res.ok) location.reload();
        });
    }

    function startTimer(id, minutes) {
      const timerEl = document.getElementById(`timer-${id}`);
      const startBtn = document.getElementById(`start-${id}`);
      const completeBtn = document.getElementById(`complete-${id}`);

      // prevent restarting
      if (startBtn.disabled) return;
      startBtn.disabled = true;

      let timeLeft = minutes * 60;

      const interval = setInterval(() => {
        const min = Math.floor(timeLeft / 60);
        const sec = timeLeft % 60;
        timerEl.textContent = `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        timeLeft--;

        if (timeLeft < 0) {
          clearInterval(interval);
          timerEl.textContent = "Готово!";
          completeBtn.disabled = false; // enable Complete
        }
      }, 1000);

      // optional: record start in backend
      fetch(`/start-mission/${id}`, { method: 'POST' });
    }

  </script>

</body>

</html>